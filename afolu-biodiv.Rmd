---
title: "AFOLU and Biodiversity"
author: "Marcus Thomson"
date: '2022-02-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries ----
```{r, message=FALSE}
library(tidyverse)
library(raster)
library(sf)
library(maps)
library(rgdal)
```


## Load data
### Biodiversity
Species richness for all species.
Source: IUCN. (2022). IUCN Redlist database. <https://www.iucnredlist.org> Retrieved: 25/02/2022.
```{r}
biodiv_data <- raster("data/Richness_all.tif")
```

### Country political borders
Shapefiles for country-level political boundaries (borders).
Source: <https://public.opendatasoft.com/explore/dataset/world-administrative-boundaries>
NB: Should update this to use a newer method.
```{r, message=FALSE}
borders_only <- readOGR(dsn = "data/world-administrative-boundaries", layer = "world-administrative-boundaries")
```

### Pathways & historical data
Historical data from the FAO.
Source: FAO.
```{r, show_col_types=FALSE}
pathways <- readr::read_csv("data/food_feed_pathways.csv")
hist_fao <- readr::read_csv("data/food_feed_fao.csv")
hist_fao <- hist_fao %>%
   dplyr::rename(fao_countrycode = area_code)
```

### Map country names to ISO codes
DF to map ISO3 codes to country names.
```{r}
country_code_map <- readr::read_csv("data/country_mapper.csv")
```

## Organize pathways data
Rename and arrange historical FAO data columns to make it more alike the projected pathways data frame.
```{r}
historical_pathways <- country_code_map %>%
  dplyr::right_join(
    hist_fao, 
    by = "fao_countrycode"
  ) %>% 
  dplyr::mutate(
    diet_plan = "Hist-FAO", 
    scenario = "historical", 
    kt_yr_se = NA, 
    target_year = NA
  ) %>% 
  dplyr::select(iso_alpha3, diet_plan, scenario, food_group, year, kt_yr, kt_yr_smoothed, diff1, diff2)
```

## Crop and mask biodiversity raster
The global biodiversity raster must be mapped to countries. First make a list of extant country ISO3 codes.
```{r}
country_iso3_codes <-
  borders_only@data$iso3[!is.na(borders_only@data$iso3)]
country_iso3_codes <-
  as.character(country_iso3_codes[order(country_iso3_codes)])
country_iso3_df <-
  data.frame(index = country_iso3_codes %>% dplyr::row_number(),
             iso3 = country_iso3_codes)
```

Next, crop and then mask `biodiv_data` by individual country border polygons.
```{r}
borders_only_sub <-
  borders_only[as.character(borders_only@data$iso3) %in% country_iso3_df$iso3,]
```

The spatial polygons data frame (SPDF) `borders_only_sub` contains data for only those countries that have corresponding ISO3 codes, excluding entities that are disputed or might be double-counted.

Loop over iso3 codes to make a list of biodiveristy rasters for each country.
```{r}
biodiv_country_rast <- list()
for (country_iso3 in country_iso3_codes) {
  biodiv_sub <-
    crop(biodiv_data, extent(borders_only_sub[borders_only_sub$iso3 == country_iso3, ]))
  biodiv_country_rast[[country_iso3]] <-
    mask(biodiv_sub, borders_only_sub[borders_only_sub$iso3 == country_iso3, ])
}
```


`biodiv_country_rast` is a list of rasters geospatially located within country-level border polygon perimeters. Because this is a large object for the complete list of countries, make another list with pertinent information, including statistical moments of the masked raster values. This is a much lighter object.

Extract some basic data (mean, sd, median, min, max) from each of these.
```{r}
get_raster_summary <- function(x) {
  tmp1 <- raster::values(x) %>%
    na.omit() %>%
    summary() %>%
    as.vector()
  
  tmp2 <- raster::values(x) %>%
    na.omit() %>%
    sd()
  
  return(data.frame(
    names = c(
      "min",
      "first_quart",
      "median",
      "mean",
      "third_quart",
      "max",
      "sd"
    ),
    biodiv = c(tmp1, tmp2)
  ))
}

biodiv_country_moments <-
  lapply(biodiv_country_rast, FUN = get_raster_summary)
```

## Analysis
Now that the data has been ordered, proceed to analytics. First, let's make a simple list of countries by median biodiversity.
```{r}
median_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][3]
}
mean_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][4]
}
sd_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][7]
}

median_tmp <- lapply(names(biodiv_country_moments), FUN = median_vals)
mean_tmp <- lapply(names(biodiv_country_moments), FUN = mean_vals)
sd_tmp <- lapply(names(biodiv_country_moments), FUN = sd_vals)

biodiv_moments_df <- data.frame(
  iso_alpha3 = names(biodiv_country_moments),
  biodiv_median = unlist(median_tmp), 
  biodiv_mean = unlist(mean_tmp), 
  biodiv_sd = unlist(sd_tmp)
)

rm(median_tmp, mean_tmp)
```

### Find pathway ROC gaps
We want to see the difference between transformation pathway and historical values; so first transformation pathways...
```{r}
trans_pathways_moments <- pathways %>%
  dplyr::group_by(iso_alpha3, diet_plan, scenario, food_group, target_year) %>%
  dplyr::filter(!is.na(diff1)) %>%
  dplyr::summarise(
    diff1_ave = mean(diff1, na.rm = TRUE),
    diff1_med = median(diff1, na.rm = TRUE),
    diff1_sdv = sd(diff1, na.rm = TRUE),
    .groups = "drop"
  )
```

...and then historical pathways.
```{r}
hist_pathways_moments <- historical_pathways %>%
  dplyr::group_by(iso_alpha3, food_group)  %>%
  dplyr::summarise(
    hist_diff1_ave = mean(diff1, na.rm = TRUE),
    hist_diff1_med = median(diff1, na.rm = TRUE),
    hist_diff1_sdv = sd(diff1, na.rm = TRUE),
    .groups = "drop"
  )
```

Next, let's take differences (delta) between long-term averages of historical (FAO) and transformation pathways.
```{r}
delta_pathways_moments <- trans_pathways_moments %>%
  dplyr::full_join(hist_pathways_moments, by = c("iso_alpha3", "food_group")) %>%
  dplyr::mutate(
    delta_diff1_ave = diff1_ave - hist_diff1_ave,
    delta_diff1_med = diff1_med - hist_diff1_med
  ) %>%
  dplyr::select(
    iso_alpha3,
    diet_plan,
    scenario,
    food_group,
    target_year,
    delta_diff1_ave,
    delta_diff1_med
  )
```

Merge these data sets.
```{r}
pathways_biodiv_moments_df <- delta_pathways_moments %>%
  dplyr::full_join(biodiv_moments_df, by = "iso_alpha3") %>%
  tidyr::drop_na()
```

`pathways_biodiv_moments_df` contains differences (deltas) between transformation and historical pathway means and medians, which I call "gaps".

### Test of gaps
Let's carry out a test to see what it looks like.
```{r}
test <- pathways_biodiv_moments_df %>%
  dplyr::filter(diet_plan == "CNS-CFP" &
                  scenario == "SSP3" &
                  food_group == "plant products")
```

Large-positive outliers in the deltas between transformation and FAO pathways:
*IND 24026.28 (target_year = 2045) to 19937.48 (target_year = 2065)
*NGA 6423.032 (2045) to 7037.927 (2055)
*PAK 5236.188 (2065) to 6345.643 (2050)

Large-negative outliers in the deltas between transformation and FAO pathways:
*CHN -40496.5 (target_year = 2050) to -36018.513 (target_year = 2065)
*USA -4618.142 (2050) to -4062.990 (2065)

Filter these countries out for the test
```{r}
test <- test %>% 
  dplyr::filter(!iso_alpha3 %in% c("CHN", "IND", "NGA", "PAK", "USA"))
```

Plot the test data
```{r}
ggplot(test %>% 
         dplyr::filter(diet_plan == "CNS-CFP" & scenario == "SSP3" & food_group == "plant products" & target_year == 2050) %>% 
         dplyr::filter(delta_diff1_ave >= 0), 
       aes(x = delta_diff1_ave, 
           y = biodiv_mean)) + 
  geom_point(col = "darkblue") + 
  geom_smooth(method = "lm") + 
  theme_minimal() + 
  labs(
    title = "Increasing pathway gaps for high biodiversity countries", 
    subtitle = "filters: CNS diet, SSP3 scenario, 2050 target year for plant products only",
    caption = "IND, NGA & PAK omitted as high outliers", 
    x = "Difference between transformation pathway ROC and FAO historical ROC (kt/yr)", 
    y = "Mean biodiveristy index by country"
  )
```

```{r}
ggplot(test %>% 
         dplyr::filter(diet_plan == "CNS-CFP" & scenario == "SSP3" & food_group == "plant products" & target_year == 2050) %>% 
         dplyr::filter(delta_diff1_ave >= 0), 
       aes(x = log(delta_diff1_ave), 
           y = biodiv_mean)) + 
  geom_point(col = "darkblue") + 
  geom_smooth(method = "lm") + 
  theme_minimal()
```


- intensification or imports
- make a new plot: for each point, what is its value in terms of 
- find signatories to a UN biodiversity assessment
- order of magnitude more difficult to meet food commitments than increase biodiversity

- do the same hist distribution vs biodiversity
- steepness of curves (general population growth, target date) how does the slope of the regression change as a function of target date
- what countries does target date matter, what  countries doesn't it matter?
- basket we want to know: high biodiversity, target date matters, rank these

- 2 d coordinate system: how high is its biodiversity, how hard is it for country to meet it s food needs
- make a conceptual diagram with a model country that epitomizes each of these quadrants 
- PCR test to see what the variance around each term is

Historical pathways and biodiversity
```{r}
test <- hist_pathways_moments %>% 
  full_join(biodiv_moments_df, by = "iso_alpha3") %>% 
  filter(!is.na(hist_diff1_ave) & !is.na(biodiv_median) & !is.na(iso_alpha3))

```


```{r}
plant_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
animal_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "animal products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "animal products") %>% 
    pull(biodiv_mean)
)
fish_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "fish & seafood") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "fish & seafood") %>% 
    pull(biodiv_mean)
)

plant_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
animal_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "animal products") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "animal products") %>% 
    pull(biodiv_mean)
)
fish_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "fish & seafood") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "fish & seafood") %>% 
    pull(biodiv_mean)
)

corval_labs_pos = c(
  paste0(
    "r = ",
    round(plant_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(plant_prod_pos_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(animal_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(animal_prod_pos_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(fish_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(fish_prod_pos_corr$p.value, 1),
    ")"
  )
)
corval_labs_neg = c(
  paste0(
    "r = ",
    round(plant_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(plant_prod_neg_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(animal_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(animal_prod_neg_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(fish_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(fish_prod_neg_corr$p.value, 1),
    ")"
  )
)

annotate_text <- data.frame(
  food_group = c("plant products", "animal products", "fish & seafood"),
  corval_labs_pos, 
  corval_labs_neg
)

```


```{r}
p_pos <- ggplot(data = test %>% 
         filter(hist_diff1_ave > 0), 
       aes(x = hist_diff1_ave, 
           y = biodiv_mean)) + 
  geom_point(colour = scales::muted("blue"), alpha = 0.5) + 
  geom_errorbar(aes(xmin = hist_diff1_ave - hist_diff1_sdv, xmax = hist_diff1_ave + hist_diff1_sdv), colour = scales::muted("blue"), width=.2, alpha = 0.5) + 
  geom_errorbar(aes(ymin = biodiv_mean - biodiv_sd, ymax = biodiv_mean + biodiv_sd), colour = scales::muted("blue"), width=.2, alpha = 0.5) + 
  # geom_text(aes(label = iso_alpha3), 
  #           alpha = 0.7, 
  #           size = 3) + 
  geom_smooth(colour = "firebrick", method = "lm") + 
  geom_text(
  data    = annotate_text,
  mapping = aes(x = 1e2, y = 44, label = corval_labs_pos),
  hjust   = 0.4,
  vjust   = 0.9, 
  size = 3
) + 
  theme_bw() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank()
  ) + 
  labs(
    title = "High biodiveristy countries have experienced more rapid up-shifts in historical supply", 
    subtitle = "Source: FAO",
    x = "Average FAO historical ROC (kt/yr)", 
    y = "Mean species richness by country"
  ) + 
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
              labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  facet_wrap(~ food_group)

p_neg <- ggplot(data = test %>% 
         filter(hist_diff1_ave < 0), 
       aes(x = abs(hist_diff1_ave), 
           y = biodiv_mean)) + 
  geom_point(colour = scales::muted("blue"), alpha = 0.5) + 
  geom_errorbar(aes(xmin = hist_diff1_ave - hist_diff1_sdv, xmax = hist_diff1_ave + hist_diff1_sdv), colour = scales::muted("blue"), width=.2, alpha = 0.5) + 
  geom_errorbar(aes(ymin = biodiv_mean - biodiv_sd, ymax = biodiv_mean + biodiv_sd), colour = scales::muted("blue"), width=.2, alpha = 0.5) + 
  # geom_text(aes(label = iso_alpha3), 
  #           alpha = 0.7, 
  #           size = 3) + 
  geom_smooth(colour = "firebrick", method = "lm") + 
  geom_text(
  data    = annotate_text,
  mapping = aes(x = 10, y = 44, label = corval_labs_neg),
  hjust   = 0.4,
  vjust   = 0.9, 
  size = 3
) + 
  theme_bw() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank()
  ) + 
  labs(
    title = "Down-shifts in historical supply have no correlation with biodiversity", 
    subtitle = "Source: FAO",
    x = "Average FAO historical ROC (kt/yr)", 
    y = "Mean species richness by country"
  ) + 
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x){
    tmp <- abs(x)
    10^tmp
  }),
              labels = scales::trans_format("log10", scales::math_format(-10^.x))) +
  facet_wrap(~ food_group)

cowplot::plot_grid(p_pos, p_neg, ncol = 1)

```

```{r}
cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
```


Pearson's correlation coefficient for the test data
```{r}
cor.test(test$delta_diff1_ave, test$biodiv_mean)
```

### Across all pathways
Pathways are defined by combinations of diets, SSP scenarios, food groups and target years. Let's examine correlations across all combinations. Start with a combination matrix.
```{r}
combination_matrix <- expand.grid(
  diet_plan = c("CNS-CFP", "ELA-PHD", "FDA-SDP"),
  scenario = c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5"),
  food_group = c("animal products", "fish & seafood", "plant products"),
  target_year = seq(2045, 2065, by = 5)
)

combination_matrix <- combination_matrix %>% 
  dplyr::mutate(index = 1:225) # the matrix is 225 rows long
```

These countries have inordinately large ROC gaps. Negative gaps, for the USA and CHN, are a consequence of the historical supply surplus in the US and likely future population drop in China. Positive gaps are due to India, Nigeria and Pakistan's dependence on food imports (low historical supply) and very high future demand from population growth.
```{r}
outlier_countries <- c("CHN", "IND", "NGA", "PAK", "USA")
```

First look at positive pathway ROC gaps (i.e., transformation pathway ROC is greater than historical ROC).
```{r}
for(index in 1:225) {
  tmp0 <- combination_matrix[index, ]
  tmp1 <- pathways_biodiv_moments_df %>% 
    dplyr::filter(delta_diff1_ave >= 0) %>% 
    dplyr::filter(
      diet_plan == as.character(tmp0$diet_plan) &
        scenario == as.character(tmp0$scenario) &
        food_group == as.character(tmp0$food_group) &
        target_year == as.double(tmp0$target_year)
    )
  tmp2 <- cor.test(tmp1$delta_diff1_ave, tmp1$biodiv_mean)
  tmp3 <- data.frame(
    index = index, 
    teststat = tmp2$statistic,
    df = tmp2$parameter, 
    corr = tmp2$estimate, 
    pval = tmp2$p.value
  )
  if(index == 1) {
    pos_corr_tests <- tmp3
  } else {
    pos_corr_tests <- pos_corr_tests %>% 
      dplyr::bind_rows(tmp3)
  }
}
```

Next, negative pathway ROC gaps (i.e., transformation ROC is less than historic ROC).
```{r}
for(index in 1:225) {
  tmp0 <- combination_matrix[index, ]
  tmp1 <- pathways_biodiv_moments_df %>% 
    dplyr::filter(delta_diff1_ave < 0) %>% 
    dplyr::filter(
      diet_plan == as.character(tmp0$diet_plan) &
        scenario == as.character(tmp0$scenario) &
        food_group == as.character(tmp0$food_group) &
        target_year == as.double(tmp0$target_year)
    )
  tmp2 <- cor.test(tmp1$delta_diff1_ave, tmp1$biodiv_mean)
  tmp3 <- data.frame(
    index = index, 
    teststat = tmp2$statistic,
    df = tmp2$parameter, 
    corr = tmp2$estimate, 
    pval = tmp2$p.value
  )
  if(index == 1) {
    neg_corr_tests <- tmp3
  } else {
    neg_corr_tests <- neg_corr_tests %>% 
      dplyr::bind_rows(tmp3)
  }
}
```

Use the p-value to filter significant correlation values.
```{r}
pos_corr_tests_filtered <- pos_corr_tests %>% 
  dplyr::filter(pval <= 0.05) %>% 
  dplyr::left_join(combination_matrix, by = "index") %>% 
  dplyr::arrange(-corr)

neg_corr_tests_filtered <- neg_corr_tests %>% 
  dplyr::filter(pval <= 0.05) %>% 
  dplyr::left_join(combination_matrix, by = "index") %>% 
  dplyr::arrange(-corr)
```

There are just 5 cases (from `neg_corr_tests_filtered`) in which the correlation estimate was significant (p-value between 0.03 and 0.047), but all correlations are negative: there are special cases in the CNS and ELA diets in which more feasible shifts occur in high-biodiversity countries.

```{r}
colz <-
  c(
    "animal products" = "#F17EB8",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

p_corr <- ggplot(
  data = pos_corr_tests_filtered %>%
    dplyr::mutate(diet_plan = ifelse(
      diet_plan == "ELA-PHD",
      "ELA",
      ifelse(diet_plan == "CNS-CFP",
             "CNS",
             "USDA")
    )),
  mapping = aes(x = target_year,
                y = corr)
) +
  geom_point(aes(shape = food_group,
                 colour = food_group), 
             size = 2) +
  scale_color_manual(labels = labz, 
                     values = colz) +
  scale_shape_manual(labels = labz, 
                     values = c(15, 16, 17)) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.5,
      vjust = 0.5,
      size = 7
    )
  ) +
  labs(
    title = "Food system up-shifts are less feasible for high biodiversity countries",
    subtitle = "Correlation (p < 0.05) between mean biodiveristy index and food shift feasibility gap",
    x = "target year",
    y = "Pearson's correlation coefficient"
  ) +
  facet_grid(diet_plan ~ scenario)

p_corr
```



