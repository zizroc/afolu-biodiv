---
title: "AFOLU and Biodiversity"
author: "Marcus Thomson"
date: '2022-02-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries ----
```{r, message=FALSE}
library(tidyverse)
library(raster)
library(sf)
library(maps)
library(rgdal)
```


## Load data
### Biodiversity
Species richness for all species.
Source: IUCN. (2022). IUCN Redlist database. <https://www.iucnredlist.org> Retrieved: 25/02/2022.
```{r}
biodiv_data <- raster("data/Richness_all.tif")
```

### Country political borders
Shapefiles for country-level political boundaries (borders).
Source: <https://public.opendatasoft.com/explore/dataset/world-administrative-boundaries>
NB: Should update this to use a newer method.
```{r, message=FALSE}
borders_only <- readOGR(dsn = "data/world-administrative-boundaries", layer = "world-administrative-boundaries")
```

### Pathways & historical data
Historical data from the FAO.
Source: FAO.
```{r, show_col_types=FALSE}
pathways <- readr::read_csv("data/food_feed_pathways.csv")
hist_fao <- readr::read_csv("data/food_feed_fao.csv")
hist_fao <- hist_fao %>%
   dplyr::rename(fao_countrycode = area_code)
```

### Map country names to ISO codes
DF to map ISO3 codes to country names.
```{r}
country_code_map <- readr::read_csv("data/country_mapper.csv")
```

## Organize pathways data
Rename and arrange historical FAO data columns to make it more alike the projected pathways data frame.
```{r}
historical_pathways <- country_code_map %>%
  dplyr::right_join(
    hist_fao, 
    by = "fao_countrycode"
  ) %>% 
  dplyr::mutate(
    diet_plan = "Hist-FAO", 
    scenario = "historical", 
    kt_yr_se = NA, 
    target_year = NA
  ) %>% 
  dplyr::select(iso_alpha3, diet_plan, scenario, food_group, year, kt_yr, kt_yr_smoothed, diff1, diff2)
```

## Crop and mask biodiversity raster
The global biodiversity raster must be mapped to countries. First make a list of extant country ISO3 codes.
```{r}
country_iso3_codes <-
  borders_only@data$iso3[!is.na(borders_only@data$iso3)]
country_iso3_codes <-
  as.character(country_iso3_codes[order(country_iso3_codes)])
country_iso3_df <-
  data.frame(index = country_iso3_codes %>% dplyr::row_number(),
             iso3 = country_iso3_codes)
```

Next, crop and then mask `biodiv_data` by individual country border polygons.
```{r}
borders_only_sub <-
  borders_only[as.character(borders_only@data$iso3) %in% country_iso3_df$iso3,]
```

The spatial polygons data frame (SPDF) `borders_only_sub` contains data for only those countries that have corresponding ISO3 codes, excluding entities that are disputed or might be double-counted.

Loop over iso3 codes to make a list of biodiveristy rasters for each country.
```{r}
biodiv_country_rast <- list()
for (country_iso3 in country_iso3_codes) {
  biodiv_sub <-
    crop(biodiv_data, extent(borders_only_sub[borders_only_sub$iso3 == country_iso3, ]))
  biodiv_country_rast[[country_iso3]] <-
    mask(biodiv_sub, borders_only_sub[borders_only_sub$iso3 == country_iso3, ])
}
```


`biodiv_country_rast` is a list of rasters geospatially located within country-level border polygon perimeters. Because this is a large object for the complete list of countries, make another list with pertinent information, including statistical moments of the masked raster values. This is a much lighter object.

Extract some basic data (mean, sd, median, min, max) from each of these.
```{r}
get_raster_summary <- function(x) {
  tmp1 <- raster::values(x) %>%
    na.omit() %>%
    summary() %>%
    as.vector()
  
  tmp2 <- raster::values(x) %>%
    na.omit() %>%
    sd()
  
  return(data.frame(
    names = c(
      "min",
      "first_quart",
      "median",
      "mean",
      "third_quart",
      "max",
      "sd"
    ),
    biodiv = c(tmp1, tmp2)
  ))
}

biodiv_country_moments <-
  lapply(biodiv_country_rast, FUN = get_raster_summary)
```

## Analysis
Now that the data has been ordered, proceed to analytics. First, let's make a simple list of countries by median biodiversity.
```{r}
median_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][3]
}
mean_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][4]
}

median_tmp <- lapply(names(biodiv_country_moments), FUN = median_vals)
mean_tmp <- lapply(names(biodiv_country_moments), FUN = mean_vals)

biodiv_moments_df <- data.frame(
  iso_alpha3 = names(biodiv_country_moments),
  biodiv_median = unlist(median_tmp), 
  biodiv_mean = unlist(mean_tmp)
)

rm(median_tmp, mean_tmp)
```

<!-- Next, let's simplify the pathways data by taking ensemble means of pathways across SSPs. -->
<!-- ```{r} -->
<!-- pathways_ssp_em <- pathways %>%  -->
<!--   dplyr::group_by(iso_alpha3, diet_plan, food_group, year, target_year) %>%  -->
<!--   dplyr::summarise(diff1_em = mean(diff1),  -->
<!--                    diff1_mn = min(diff1),  -->
<!--                    diff1_mx = max(diff1),  -->
<!--                    .groups = "drop") -->
<!-- ``` -->

```{r}
derdiff_df <- pathways %>%
  dplyr::filter(diet_plan == "CNS-CFP" &
                  food_group == "animal products" & target_year == 2050) %>% 
  dplyr::select(iso_alpha3, kt_yr_fit)
```


```{r}
biodiv_derdiff_df <- biodiv_moments_df %>% 
  full_join(derdiff_df)
```

```{r}
ggplot(biodiv_derdiff_df %>% 
         drop_na(), 
       aes(x = log(kt_yr_fit))) + 
  geom_point(aes(y = biodiv_median), 
             col = "blue") + 
  geom_point(aes(y = biodiv_mean), 
             col = "firebrick")
```



```{r}
tmp1 <- pathways %>%
  dplyr::filter(
    target_year == 2050 &
      iso_alpha3 == "AFG" &
      food_group == "animal products" &
      scenario == "SSP1" & diet_plan == "CNS-CFP"
  ) %>%
  dplyr::pull(diff1) %>%
  na.omit() 
```


```{r}
tmp2 <- historical_pathways %>%
  dplyr::filter(
      iso_alpha3 == "AFG" &
      food_group == "animal products"
  ) %>%
  dplyr::pull(diff1) %>%
  na.omit() 
```


```{r}

ggplot(
  data = pathways %>%
    dplyr::filter(
      iso_alpha3 == "AFG" &
        food_group == "plant products" &
        diet_plan == "CNS-CFP" & 
        scenario == "SSP3"
    ),
  aes(x = diff2)
) +
  geom_density(aes(fill = as.factor(target_year)), 
               alpha = 0.5) + 
  geom_density(data = historical_pathways %>%
    dplyr::filter(
      iso_alpha3 == "AFG" &
        food_group == "plant products"), 
               mapping = aes(x = diff2), 
               alpha = 0.1)

```



```{r}

```




## Including Plots

You can also embed plots, for example:

```{r, echo=FALSE}

```


