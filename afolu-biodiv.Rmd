---
title: "AFOLU and Biodiversity"
author: "Marcus Thomson"
date: '2022-02-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries ----
```{r, message=FALSE}
library(tidyverse)
library(raster)
library(sf)
library(maps)
library(rgdal)
```


## Load data
### Biodiversity
Species richness for all species, and for critically endangered and vulnerable (CRENVU) species.
Source: IUCN. (2022). IUCN Redlist database. <https://www.iucnredlist.org> Retrieved: 25/02/2022.
```{r}
speciesrichness_data <- raster("data/Richness_all.tif") 
crenvu_data <- raster("data/Richness_crenvu.tif")
```

These countries are members of the [High Ambition Coalition](https://www.hacfornatureandpeople.org)
Source: HAC. (2022). HAC Members list. <https://www.hacfornatureandpeople.org/hac-members> Retrieved: 4/3/2022.
```{r}
hac_countries_map <- readr::read_csv("data/High Ambition Coalition list - HAC_members_03-2022.csv")
```


### Country political borders
Shapefiles for country-level political boundaries (borders).
Source: <https://public.opendatasoft.com/explore/dataset/world-administrative-boundaries>
NB: Should update this to use a newer method.
```{r, message=FALSE}
borders_only <- readOGR(dsn = "data/world-administrative-boundaries", layer = "world-administrative-boundaries")
```

### Pathways & historical data
Historical data from the FAO.
Source: FAO.
```{r, show_col_types=FALSE}
pathways <- readr::read_csv("data/food_feed_pathways.csv")
hist_fao <- readr::read_csv("data/food_feed_fao.csv")
hist_fao <- hist_fao %>%
   dplyr::rename(fao_countrycode = area_code)
```

### Map country names to ISO codes
DF to map ISO3 codes to country names.
```{r}
country_code_map <- readr::read_csv("data/country_mapper.csv")
```


## Organize pathways data
Rename and arrange historical FAO data columns to make it more alike the projected pathways data frame.
```{r}
historical_pathways <- country_code_map %>%
  dplyr::right_join(
    hist_fao, 
    by = "fao_countrycode"
  ) %>% 
  dplyr::mutate(
    diet_plan = "Hist-FAO", 
    scenario = "historical", 
    kt_yr_se = NA, 
    target_year = NA
  ) %>% 
  dplyr::select(iso_alpha3, diet_plan, scenario, food_group, year, kt_yr, kt_yr_smoothed, diff1, diff2)
```

## Crop and mask biodiversity raster
The global biodiversity raster must be mapped to countries. First make a list of extant country ISO3 codes.
```{r}
country_iso3_codes <-
  borders_only@data$iso3[!is.na(borders_only@data$iso3)]
country_iso3_codes <-
  as.character(country_iso3_codes[order(country_iso3_codes)])
country_iso3_df <-
  data.frame(index = country_iso3_codes %>% dplyr::row_number(),
             iso3 = country_iso3_codes)
```

Next, crop and then mask `biodiv_data` by individual country border polygons.
```{r}
borders_only_sub <-
  borders_only[as.character(borders_only@data$iso3) %in% country_iso3_df$iso3,]
```

The spatial polygons data frame (SPDF) `borders_only_sub` contains data for only those countries that have corresponding ISO3 codes, excluding entities that are disputed or might be double-counted.

What proxy are we using for biodiversity? If it is species richness, use `speciesrichness_data`. If it is the number of species that are critically endangered and vulnerable, use `crenvu_data`.
```{r}
biodiv_data <- crenvu_data

# used for ease of making plot labels below
if(identical(raster::values(biodiv_data), raster::values(crenvu_data))) {
  biodiv_index = "critically endangered & vulnerable species"
} else {
  biodiv_index = "species richness"
}

```


Loop over iso3 codes to make a list of biodiveristy rasters for each country.
```{r}
biodiv_country_rast <- list()
for (country_iso3 in country_iso3_codes) {
  biodiv_sub <-
    crop(biodiv_data, extent(borders_only_sub[borders_only_sub$iso3 == country_iso3,]))
  biodiv_country_rast[[country_iso3]] <-
    mask(biodiv_sub, borders_only_sub[borders_only_sub$iso3 == country_iso3,])
}
```


`biodiv_country_rast` is a list of rasters geospatially located within country-level border polygon perimeters. Because this is a large object for the complete list of countries, make another list with pertinent information, including statistical moments of the masked raster values. This is a much lighter object.

Extract some basic data (mean, sd, median, min, max) from each of these.
```{r}
get_raster_summary <- function(x) {
  tmp1 <- raster::values(x) %>%
    na.omit() %>%
    summary() %>%
    as.vector()
  
  tmp2 <- raster::values(x) %>%
    na.omit() %>%
    sd()
  
  return(data.frame(
    names = c(
      "min",
      "first_quart",
      "median",
      "mean",
      "third_quart",
      "max",
      "sd"
    ),
    biodiv = c(tmp1, tmp2)
  ))
}

biodiv_country_moments <-
  lapply(biodiv_country_rast, FUN = get_raster_summary)
```

## Analysis
Now that the data has been ordered, proceed to analytics. First, let's make a simple list of countries by median biodiversity.
```{r}
median_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][3]
}
mean_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][4]
}
sd_vals <- function(x) {
  biodiv_country_moments[[x]][[2]][7]
}

median_tmp <- lapply(names(biodiv_country_moments), FUN = median_vals)
mean_tmp <- lapply(names(biodiv_country_moments), FUN = mean_vals)
sd_tmp <- lapply(names(biodiv_country_moments), FUN = sd_vals)

biodiv_moments_df <- data.frame(
  iso_alpha3 = names(biodiv_country_moments),
  biodiv_median = unlist(median_tmp), 
  biodiv_mean = unlist(mean_tmp), 
  biodiv_sd = unlist(sd_tmp)
)

rm(median_tmp, mean_tmp)
```

### Find pathway ROC gaps
We want to see the difference between transformation pathway and historical values; so first transformation pathways...
```{r}
trans_pathways_moments <- pathways %>%
  dplyr::group_by(iso_alpha3, diet_plan, scenario, food_group, target_year) %>%
  dplyr::filter(!is.na(diff1)) %>%
  dplyr::summarise(
    diff1_ave = mean(diff1, na.rm = TRUE),
    diff1_med = median(diff1, na.rm = TRUE),
    diff1_sdv = sd(diff1, na.rm = TRUE),
    .groups = "drop"
  )
```

...and then historical pathways.
```{r}
hist_pathways_moments <- historical_pathways %>%
  dplyr::group_by(iso_alpha3, food_group)  %>%
  dplyr::summarise(
    hist_diff1_ave = mean(diff1, na.rm = TRUE),
    hist_diff1_med = median(diff1, na.rm = TRUE),
    hist_diff1_sdv = sd(diff1, na.rm = TRUE),
    .groups = "drop"
  )
```

Next, let's take differences (delta) between long-term averages of historical (FAO) and transformation pathways.
```{r}
delta_pathways_moments <- trans_pathways_moments %>%
  dplyr::full_join(hist_pathways_moments, by = c("iso_alpha3", "food_group")) %>%
  dplyr::mutate(
    delta_diff1_ave = diff1_ave - hist_diff1_ave,
    delta_diff1_med = diff1_med - hist_diff1_med
  ) %>%
  dplyr::select(
    iso_alpha3,
    diet_plan,
    scenario,
    food_group,
    target_year,
    delta_diff1_ave,
    delta_diff1_med
  )
```

Merge these data sets.
```{r}
pathways_biodiv_moments_df <- delta_pathways_moments %>%
  dplyr::full_join(biodiv_moments_df, by = "iso_alpha3") %>%
  tidyr::drop_na()
```

`pathways_biodiv_moments_df` contains differences (deltas) between transformation and historical pathway means and medians, which I call "gaps".

### Test of gaps
Let's carry out a test to see what it looks like.
```{r}
test <- pathways_biodiv_moments_df %>%
  dplyr::filter(diet_plan == "CNS-CFP" &
                  scenario == "SSP3" &
                  food_group == "plant products")
```

Large-positive outliers in the deltas between transformation and FAO pathways:
*IND 24026.28 (target_year = 2045) to 19937.48 (target_year = 2065)
*NGA 6423.032 (2045) to 7037.927 (2055)
*PAK 5236.188 (2065) to 6345.643 (2050)

Large-negative outliers in the deltas between transformation and FAO pathways:
*CHN -40496.5 (target_year = 2050) to -36018.513 (target_year = 2065)
*USA -4618.142 (2050) to -4062.990 (2065)

HAC countries
```{r}
hac_codes <- hac_countries_map %>% 
               dplyr::pull(iso_alpha3)
```


Plot the test data
```{r}
ggplot(
  test %>%
    dplyr::filter(
      diet_plan == "CNS-CFP" &
        scenario == "SSP3" &
        food_group == "plant products" & target_year == 2050
    ) %>%
    dplyr::filter(delta_diff1_ave >= 0),
  aes(x = delta_diff1_ave,
      y = biodiv_mean)
) +
  geom_point(colour = scales::muted("firebrick"), alpha = 0.5) + 
  geom_smooth(method = "lm", colour = "firebrick") +
  geom_point(data = test %>%
    dplyr::filter(
      diet_plan == "CNS-CFP" &
        scenario == "SSP3" &
        food_group == "plant products" & target_year == 2050
    ) %>%
    dplyr::filter(delta_diff1_ave >= 0) %>% 
      dplyr::filter(iso_alpha3 %in% hac_codes), 
    aes(x = delta_diff1_ave,
      y = biodiv_mean), 
    colour = "blue",
    size = 2, 
    shape = 2) + 
  geom_smooth(data = test %>%
    dplyr::filter(
      diet_plan == "CNS-CFP" &
        scenario == "SSP3" &
        food_group == "plant products" & target_year == 2050
    ) %>%
    dplyr::filter(delta_diff1_ave >= 0) %>% 
      dplyr::filter(iso_alpha3 %in% hac_codes), 
    mapping = aes(x = delta_diff1_ave,
      y = biodiv_mean), 
    method = "lm", colour = "blue", linetype = 2) + 
  theme_bw() +
  labs(
    title = "Increasing pathway gaps for high biodiversity countries",
    subtitle = "filters: CNS diet, SSP3 scenario, 2050 target year for plant products only",
    x = "Difference between transformation pathway ROC and FAO historical ROC (kt/yr)",
    y = biodiv_index
  ) +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^
                                                                 .x))
  )
```

### Look at historical ROCs
Historical pathways and biodiversity
```{r}
test <- hist_pathways_moments %>% 
  full_join(biodiv_moments_df, by = "iso_alpha3") %>% 
  filter(!is.na(hist_diff1_ave) & !is.na(biodiv_median) & !is.na(iso_alpha3))

```

Make some annotation label dfs to show correlation coefficients on the plot facets.
```{r}
plant_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
animal_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "animal products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "animal products") %>% 
    pull(biodiv_mean)
)
fish_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "fish & seafood") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "fish & seafood") %>% 
    pull(biodiv_mean)
)

plant_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
animal_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "animal products") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "animal products") %>% 
    pull(biodiv_mean)
)
fish_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "fish & seafood") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "fish & seafood") %>% 
    pull(biodiv_mean)
)

corval_labs_pos = c(
  paste0(
    "r = ",
    round(plant_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(plant_prod_pos_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(animal_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(animal_prod_pos_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(fish_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(fish_prod_pos_corr$p.value, 1),
    ")"
  )
)
corval_labs_neg = c(
  paste0(
    "r = ",
    round(plant_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(plant_prod_neg_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(animal_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(animal_prod_neg_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(fish_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(fish_prod_neg_corr$p.value, 1),
    ")"
  )
)

annotate_text <- data.frame(
  food_group = c("plant products", "animal products", "fish & seafood"),
  corval_labs_pos, 
  corval_labs_neg
)
```

Plot the historical data.
```{r}
p_pos0 <- ggplot(data = test %>%
                  filter(hist_diff1_ave > 0),
                aes(x = hist_diff1_ave,
                    y = biodiv_mean)) +
  geom_point(colour = scales::muted("firebrick"), alpha = 0.5) +
  geom_errorbar(
    aes(
      xmin = hist_diff1_ave - hist_diff1_sdv,
      xmax = hist_diff1_ave + hist_diff1_sdv
    ),
    colour = scales::muted("firebrick"),
    width = .2,
    alpha = 0.5
  ) +
  geom_errorbar(
    aes(ymin = biodiv_mean - biodiv_sd, ymax = biodiv_mean + biodiv_sd),
    colour = scales::muted("firebrick"),
    width = .2,
    alpha = 0.5
  ) +
  geom_smooth(colour = "black", method = "lm") +
  theme_bw() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(
    title = "High biodiveristy countries have experienced more rapid up-shifts in historical supply",
    subtitle = "Source: FAO",
    x = "Average FAO historical ROC (kt/yr)",
    y = biodiv_index
  ) +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^
                                                                 .x))
  )
p_pos <- p_pos0 +
  geom_text(
    data    = annotate_text,
    mapping = aes(x = 1e2, y = 44, label = corval_labs_pos),
    hjust   = 0.4,
    vjust   = 0.9,
    size = 3
  ) +
  facet_wrap( ~ food_group)

p_neg0 <- ggplot(data = test %>%
                  filter(hist_diff1_ave < 0),
                aes(x = abs(hist_diff1_ave),
                    y = biodiv_mean)) +
  geom_point(colour = scales::muted("firebrick"), alpha = 0.5) +
  geom_errorbar(
    aes(
      xmin = hist_diff1_ave - hist_diff1_sdv,
      xmax = hist_diff1_ave + hist_diff1_sdv
    ),
    colour = scales::muted("firebrick"),
    width = .2,
    alpha = 0.5
  ) +
  geom_errorbar(
    aes(ymin = biodiv_mean - biodiv_sd, ymax = biodiv_mean + biodiv_sd),
    colour = scales::muted("firebrick"),
    width = .2,
    alpha = 0.5
  ) +
  geom_smooth(colour = "black", method = "lm") +
  theme_bw() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(
    title = "Down-shifts in historical supply have no correlation with biodiversity",
    subtitle = "Source: FAO",
    x = "Average FAO historical ROC (kt/yr)",
    y = biodiv_index
  ) +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x) {
      tmp <- abs(x)
      10 ^ tmp
    }),
    labels = scales::trans_format("log10", scales::math_format(-10 ^
                                                                 .x))
  )
p_neg <- p_neg0 +
  geom_text(
    data    = annotate_text,
    mapping = aes(x = 10, y = 44, label = corval_labs_neg),
    hjust   = 0.4,
    vjust   = 0.9,
    size = 3
  ) +
  facet_wrap( ~ food_group)
```


```{r}
cowplot::plot_grid(p_pos, p_neg, ncol = 1)
```

This shows that large increases in the ROC of production (up-shifts) are more common in high-biodiversity countries, and decreases (down-shifts) are not correlated at all.

Is this different for countries that have signed up to the HAC pledge?
```{r}
test <- test %>% 
  dplyr::filter(iso_alpha3 %in% hac_codes)
```

Run the correlations again.
```{r}
plant_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
animal_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "animal products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "animal products") %>% 
    pull(biodiv_mean)
)
fish_prod_pos_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "fish & seafood") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "fish & seafood") %>% 
    pull(biodiv_mean)
)

plant_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
animal_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "animal products") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "animal products") %>% 
    pull(biodiv_mean)
)
fish_prod_neg_corr <- cor.test(
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "fish & seafood") %>% 
    mutate(hist_diff1_ave = log(abs(hist_diff1_ave))) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave < 0 & food_group == "fish & seafood") %>% 
    pull(biodiv_mean)
)

corval_labs_pos = c(
  paste0(
    "r = ",
    round(plant_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(plant_prod_pos_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(animal_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(animal_prod_pos_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(fish_prod_pos_corr$estimate, 2),
    " (p-value = ",
    signif(fish_prod_pos_corr$p.value, 1),
    ")"
  )
)
corval_labs_neg = c(
  paste0(
    "r = ",
    round(plant_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(plant_prod_neg_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(animal_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(animal_prod_neg_corr$p.value, 1),
    ")"
  ),
  paste0(
    "r = ",
    round(fish_prod_neg_corr$estimate, 2),
    " (p-value = ",
    signif(fish_prod_neg_corr$p.value, 1),
    ")"
  )
)

annotate_text <- data.frame(
  food_group = c("plant products", "animal products", "fish & seafood"),
  corval_labs_pos, 
  corval_labs_neg
)
```

Blue triangle-shaped points are over-plotted to represent HAC signatories.
```{r}
p_pos1 <- p_pos0 + 
 geom_point(data = test %>%
    dplyr::filter(hist_diff1_ave > 0), 
    aes(x = hist_diff1_ave,
      y = biodiv_mean), 
    size = 2, 
    shape = 2, 
    colour = "blue") + 
  geom_smooth(data = test %>%
    dplyr::filter(hist_diff1_ave > 0), 
    mapping = aes(x = hist_diff1_ave,
      y = biodiv_mean), 
    method = "lm", colour = "black", linetype = 2) +
  geom_text(
    data    = annotate_text,
    mapping = aes(x = 1e2, y = 44, label = corval_labs_pos),
    hjust   = 0.4,
    vjust   = 0.9,
    size = 3
  ) + 
  facet_wrap(~ food_group)

p_neg1 <- p_neg0 + 
 geom_point(data = test %>%
    dplyr::filter(hist_diff1_ave < 0), 
    aes(x = abs(hist_diff1_ave),
      y = biodiv_mean), 
    size = 2, 
    shape = 2, 
    colour = "blue") + 
  geom_smooth(data = test %>%
    dplyr::filter(hist_diff1_ave < 0), 
    mapping = aes(
      x = abs(hist_diff1_ave),
      y = biodiv_mean), 
    method = "lm", colour = "black", linetype = 2) +
  geom_text(
    data    = annotate_text,
    mapping = aes(x = 1e2, y = 44, label = corval_labs_pos),
    hjust   = 0.4,
    vjust   = 0.9,
    size = 3
  ) + 
  facet_wrap(~ food_group)
```

The over-plotted open triangles correspond to countries that are HAC signatories. The others are not. The dashed line is the linear fit to the HAC countries; the solid line is to all countries.
```{r}
cowplot::plot_grid(p_pos1, p_neg1, ncol = 1)
```

The correlation with up-shifts appears to go away entirely; it's still uncorrelated for down-shifts.


### Variance of results
#### ANOVA
How much does food group, diet plan and target year impact the outcome of delta_diff1_med?


Food group and diet plan are most significant. 
```{r}
dat_tmp <- pathways_biodiv_moments_df %>% 
  dplyr::select(-delta_diff1_med, -biodiv_median, -biodiv_sd) %>% 
  dplyr::filter(delta_diff1_ave > 0)
# %>% 
#   dplyr::filter(iso_alpha3 == "AFG") 

dat_tmp$diet_plan <- factor(dat_tmp$diet_plan, levels = c("CNS-CFP","ELA-PHD","FDA-SDP"))
dat_tmp$scenario <- factor(dat_tmp$scenario, levels = c("SSP1","SSP2","SSP3","SSP4","SSP5"))
dat_tmp$food_group <- factor(dat_tmp$food_group, levels = c("animal products", "fish & seafood", "plant products"))
dat_tmp$target_year <- factor(dat_tmp$target_year, levels = c(2045, 2050, 2055, 2060, 2065))

anova_tmp <- aov(biodiv_mean ~ delta_diff1_ave + diet_plan + scenario + food_group + target_year, data = dat_tmp)
# anova_tmp <- aov(biodiv_mean ~ delta_diff1_ave*diet_plan*scenario*target_year, data = dat_tmp)

anova_results <- summary(anova_tmp)
anova_results
```

TODO Figure out why the following is breaking.

For what countries is target year even significant?
```{r}
anova_results_df <- data.frame(iso_alpha3 = NA, pval = NA)
countries <- pathways_biodiv_moments_df %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
for(iso in countries) {
  dat_tmp <- pathways_biodiv_moments_df %>% 
  dplyr::select(-delta_diff1_med, -biodiv_median, -biodiv_sd) %>% 
  dplyr::filter(delta_diff1_ave > 0) %>% 
  dplyr::filter(iso_alpha3 == iso) %>% 
  dplyr::mutate(target_year = as.factor(target_year)) %>% 
  tidyr::drop_na()
  
  # if(length(dat_tmp$target_year) == 0) next
  
  # dat_tmp$target_year <- factor(dat_tmp$target_year, levels = c(2045, 2050, 2055, 2060, 2065))
    # dat_tmp$target_year <- as.factor(dat_tmp$target_year)
  anova_tmp <- aov(biodiv_mean ~ delta_diff1_ave + diet_plan + scenario + food_group + target_year, data = dat_tmp)
  anova_results <- summary(anova_tmp)
  
  if(!is.na(unlist(anova_results)[29])) {
     pval_tmp <- unlist(anova_results)[29]
     names(pval_tmp) <- c()
  } else {
    pval_tmp <- NA
  }
  tmp <- data.frame(
    iso_alpha3 = iso, 
    pval = pval_tmp
  )
  anova_results_df <- anova_results_df %>% 
    dplyr::bind_rows(tmp)
}
rownames(anova_results_df) <- c()

anova_results_df <- anova_results_df %>% 
  tidyr::drop_na(iso_alpha3) %>% 
  dplyr::arrange(pval)
```

Which countries show significant results?
```{r}
anova_results_df %>%
  filter(pval <= 0.05)
```


<!-- #### PCA test -->
<!-- Recode character columns as numeric. -->
<!-- ```{r} -->
<!-- diet_plans <- data.frame( -->
<!--   diet_plan = c("CNS-CFP","ELA-PHD","FDA-SDP"),  -->
<!--   ndiets = c(1,2,3) -->
<!-- ) -->
<!-- food_groups <- data.frame( -->
<!--   food_group = c("animal products", "fish & seafood", "plant products"),  -->
<!--   nfoods = c(1,2,3) -->
<!-- ) -->
<!-- ssp_scenarios <- data.frame( -->
<!--   scenario = c("SSP1","SSP2","SSP3","SSP4","SSP5"),  -->
<!--   nscen = c(1,2,3,4,5) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- recoded_pathways_df <- pathways_biodiv_moments_df %>%  -->
<!--   dplyr::left_join(diet_plans, by = "diet_plan") %>%  -->
<!--   dplyr::left_join(food_groups, by = "food_group") %>%  -->
<!--   dplyr::left_join(ssp_scenarios, by = "scenario") %>%  -->
<!--   dplyr::select(-diet_plan, -scenario, -food_group, -delta_diff1_med, -biodiv_median, -biodiv_sd) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- tmp <- recoded_pathways_df %>%  -->
<!--   dplyr::filter(iso_alpha3 == "AFG") %>%  -->
<!--   dplyr::select(-iso_alpha3) -->
<!-- ``` -->

<!-- Put this aside for the moment. It's not necessary. -->
<!-- ```{r} -->
<!-- pca_tmp <- prcomp(recoded_pathways_df[,c(2,3,4,5,6,7)], center = TRUE, scale. = TRUE) -->
<!-- pca_tmp -->
<!-- summary(pca_tmp) -->
<!-- ``` -->


- intensification or imports
- order of magnitude more difficult to meet food commitments than increase biodiversity

- steepness of curves (general population growth, target date) how does the slope of the regression change as a function of target date
- what countries does target date matter, what  countries doesn't it matter?
- basket we want to know: high biodiversity, target date matters, rank these

- 2 d coordinate system: how high is its biodiversity, how hard is it for country to meet it s food needs
- make a conceptual diagram with a model country that epitomizes each of these quadrants 
- PCR test to see what the variance around each term is

### Dependence of slopes with target year
```{r}
pathways_biodiv_moments_em <- pathways_biodiv_moments_df %>% 
  dplyr::group_by(iso_alpha3, diet_plan, food_group, target_year) %>% 
  dplyr::summarise(delta_diff1_em = mean(delta_diff1_ave, na.rm = TRUE), 
                   delta_diff1_mn = min(delta_diff1_ave, na.rm = TRUE), 
                   delta_diff1_mx = max(delta_diff1_ave, na.rm = TRUE), 
                   biodiv_em = mean(biodiv_mean, na.rm = TRUE), 
                   biodiv_mn = biodiv_em - mean(biodiv_sd, na.rm = TRUE), 
                   biodiv_mx = biodiv_em + mean(biodiv_sd, na.rm = TRUE), 
                   .groups = "drop")
```

```{r}
p_path_pos0 <- ggplot(data = pathways_biodiv_moments_em %>%
         dplyr::filter(delta_diff1_em > 0) %>% 
           dplyr::filter(diet_plan == "FDA-USD"),
       aes(x = delta_diff1_em,
           y = biodiv_em)) +
  geom_vline(xintercept = 0, alpha = 0.9) +
  geom_point(colour = scales::muted("blue"), alpha = 0.5) +
  geom_errorbar(
    aes(xmin = delta_diff1_mn,
        xmax = delta_diff1_mx),
    colour = scales::muted("blue"),
    width = .2,
    alpha = 0.5
  ) +
  geom_errorbar(
    aes(ymin = biodiv_mn,
        ymax = biodiv_mx),
    colour = scales::muted("blue"),
    width = .2,
    alpha = 0.5
  ) +
  geom_smooth(colour = "firebrick", method = "lm") + 
  theme_bw() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Up-shifts in pathway gap with biodiversity",
       x = "Average FAO historical ROC (kt/yr)",
       y = "Mean species richness by country") +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  )
```

Plot the result
```{r}
p_path_pos <- p_path_pos0 +
  facet_wrap(food_group ~ target_year, ncol = 5)
```

How do the slopes of the regression lines change as a function of target year?
```{r}
p_path_pos_dat <- ggplot_build(p_path_pos)
```

```{r}
pathways_fit_df <- p_path_pos_dat$data[[5]]
slopes_by_target_year <- pathways_fit_df %>%
  dplyr::group_by(PANEL) %>%
  dplyr::mutate(dx = x - lag(x, 1),
                dy = y - lag(y, 1)) %>%
  dplyr::summarise(dx = mean(dx, na.rm = TRUE),
                   dy = mean(dy, na.rm = TRUE)) %>%
  dplyr::mutate(slope = dy / dx,
                target_year = ifelse(PANEL == 1, 2045,
                                     ifelse(
                                       PANEL == 2, 2050,
                                       ifelse(PANEL == 3, 2055,
                                              ifelse(PANEL == 4, 2060,
                                                     2065))
                                     ))) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(target_year, slope)
```

Plotting this roughly shows that the slope stays pretty constant until 2055, after which it drops.
```{r}
ggplot(data = slopes_by_target_year, 
       aes(x = target_year, 
           y = slope)) + 
  geom_line() + 
  theme_minimal() + 
  labs(
    x = "shift target year", 
    y = "ave. species richness / pathway t food-feed demand / yr"
  )
```
### Significance testing with ANOVA
There appears to be no significant association with target year, but there is with food group.
```{r}
test_df <- pathways_biodiv_moments_em %>% 
  dplyr::filter(delta_diff1_em > 0) %>% 
  dplyr::mutate(log_delta_diff1_em = log(delta_diff1_em)) %>% 
  tidyr::drop_na()

summary(aov(lm(biodiv_em ~ log_delta_diff1_em + target_year + food_group, data = test_df)))
```

Now look at just HAC signatories.
```{r}
p_path_pos +
 geom_point(data = pathways_biodiv_moments_em %>%
    dplyr::filter(delta_diff1_em > 0) %>% 
      dplyr::filter(iso_alpha3 %in% hac_codes), 
    aes(x = abs(delta_diff1_em),
      y = biodiv_em), 
    size = 2, 
    shape = 2) + 
  geom_smooth(data = pathways_biodiv_moments_em %>%
    dplyr::filter(delta_diff1_em > 0) %>% 
      dplyr::filter(iso_alpha3 %in% hac_codes), 
    aes(x = abs(delta_diff1_em),
      y = biodiv_em), 
    method = "lm", colour = "blue", linetype = 2) + 
  coord_cartesian(xlim = c(1e-3,1e4)) + 
  facet_wrap(food_group ~ target_year, ncol = 5)
```

When just the HAC signatories are tested for covariance, the weak dependencies on target year disappear altogether.
```{r}
test_df <- pathways_biodiv_moments_em %>%
    dplyr::filter(delta_diff1_em > 0) %>% 
      dplyr::filter(iso_alpha3 %in% hac_codes) %>% 
  dplyr::mutate(log_delta_diff1_em = log(delta_diff1_em)) %>% 
  tidyr::drop_na()

summary(aov(lm(biodiv_em ~ log_delta_diff1_em + target_year + food_group, data = test_df)))
```



```{r}
cor.test(
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    mutate(hist_diff1_ave = log(hist_diff1_ave)) %>% 
    pull(hist_diff1_ave), 
  test %>% 
    filter(hist_diff1_ave > 0 & food_group == "plant products") %>% 
    pull(biodiv_mean)
)
```


Pearson's correlation coefficient for the test data
```{r}
cor.test(test$delta_diff1_ave, test$biodiv_mean)
```

### Across all pathways
Pathways are defined by combinations of diets, SSP scenarios, food groups and target years. Let's examine correlations across all combinations. Start with a combination matrix.
```{r}
combination_matrix <- expand.grid(
  diet_plan = c("CNS-CFP", "ELA-PHD", "FDA-SDP"),
  scenario = c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5"),
  food_group = c("animal products", "fish & seafood", "plant products"),
  target_year = seq(2045, 2065, by = 5)
)

combination_matrix <- combination_matrix %>% 
  dplyr::mutate(index = 1:225) # the matrix is 225 rows long
```

These countries have inordinately large ROC gaps. Negative gaps, for the USA and CHN, are a consequence of the historical supply surplus in the US and likely future population drop in China. Positive gaps are due to India, Nigeria and Pakistan's dependence on food imports (low historical supply) and very high future demand from population growth.
```{r}
outlier_countries <- c("CHN", "IND", "NGA", "PAK", "USA")
```

First look at positive pathway ROC gaps (i.e., transformation pathway ROC is greater than historical ROC).
```{r}
for(index in 1:225) {
  tmp0 <- combination_matrix[index, ]
  tmp1 <- pathways_biodiv_moments_df %>% 
    dplyr::filter(delta_diff1_ave >= 0) %>% 
    dplyr::filter(
      diet_plan == as.character(tmp0$diet_plan) &
        scenario == as.character(tmp0$scenario) &
        food_group == as.character(tmp0$food_group) &
        target_year == as.double(tmp0$target_year)
    )
  tmp2 <- cor.test(tmp1$delta_diff1_ave, tmp1$biodiv_mean)
  tmp3 <- data.frame(
    index = index, 
    teststat = tmp2$statistic,
    df = tmp2$parameter, 
    corr = tmp2$estimate, 
    pval = tmp2$p.value
  )
  if(index == 1) {
    pos_corr_tests <- tmp3
  } else {
    pos_corr_tests <- pos_corr_tests %>% 
      dplyr::bind_rows(tmp3)
  }
}
```

Next, negative pathway ROC gaps (i.e., transformation ROC is less than historic ROC).
```{r}
for(index in 1:225) {
  tmp0 <- combination_matrix[index, ]
  tmp1 <- pathways_biodiv_moments_df %>% 
    dplyr::filter(delta_diff1_ave < 0) %>% 
    dplyr::filter(
      diet_plan == as.character(tmp0$diet_plan) &
        scenario == as.character(tmp0$scenario) &
        food_group == as.character(tmp0$food_group) &
        target_year == as.double(tmp0$target_year)
    )
  tmp2 <- cor.test(tmp1$delta_diff1_ave, tmp1$biodiv_mean)
  tmp3 <- data.frame(
    index = index, 
    teststat = tmp2$statistic,
    df = tmp2$parameter, 
    corr = tmp2$estimate, 
    pval = tmp2$p.value
  )
  if(index == 1) {
    neg_corr_tests <- tmp3
  } else {
    neg_corr_tests <- neg_corr_tests %>% 
      dplyr::bind_rows(tmp3)
  }
}
```

Use the p-value to filter significant correlation values.
```{r}
pos_corr_tests_filtered <- pos_corr_tests %>% 
  dplyr::filter(pval <= 0.05) %>% 
  dplyr::left_join(combination_matrix, by = "index") %>% 
  dplyr::arrange(-corr)

neg_corr_tests_filtered <- neg_corr_tests %>% 
  dplyr::filter(pval <= 0.05) %>% 
  dplyr::left_join(combination_matrix, by = "index") %>% 
  dplyr::arrange(-corr)
```

There are just 5 cases (from `neg_corr_tests_filtered`) in which the correlation estimate was significant (p-value between 0.03 and 0.047), but all correlations are negative: there are special cases in the CNS and ELA diets in which more feasible shifts occur in high-biodiversity countries.

```{r}
colz <-
  c(
    "animal products" = "#F17EB8",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

p_corr <- ggplot(
  data = pos_corr_tests_filtered %>%
    dplyr::mutate(diet_plan = ifelse(
      diet_plan == "ELA-PHD",
      "ELA",
      ifelse(diet_plan == "CNS-CFP",
             "CNS",
             "USDA")
    )),
  mapping = aes(x = target_year,
                y = corr)
) +
  geom_point(aes(shape = food_group,
                 colour = food_group), 
             size = 2) +
  scale_color_manual(labels = labz, 
                     values = colz) +
  scale_shape_manual(labels = labz, 
                     values = c(15, 16, 17)) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.5,
      vjust = 0.5,
      size = 7
    )
  ) +
  labs(
    title = "Food system up-shifts are less feasible for high biodiversity countries",
    subtitle = "Correlation (p < 0.05) between mean biodiveristy index and food shift feasibility gap",
    x = "target year",
    y = "Pearson's correlation coefficient"
  ) +
  facet_grid(diet_plan ~ scenario)

p_corr
```



